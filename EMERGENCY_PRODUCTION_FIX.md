# ğŸš¨ Ø±Ø§Ù‡ Ø­Ù„ ÙÙˆØ±ÛŒ Ø¨Ø±Ø§ÛŒ Ø±ÙØ¹ Ø®Ø±Ø§Ø¨ÛŒ Production Server

## âš ï¸ ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ:
- Production server Ø¯Ø± Ø­Ø§Ù„ healthcheck failure Ø§Ø³Øª
- Migration Ù‡Ø§ÛŒ Django Ø¨Ø§Ø¹Ø« Ø®Ø±Ø§Ø¨ÛŒ Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯
- `column "tracking_code" of relation "core_order" already exists` error

## âš¡ Ø±Ø§Ù‡ Ø­Ù„ ÙÙˆØ±ÛŒ (Ø§Ù‚Ø¯Ø§Ù… ÙÙˆØ±ÛŒ Ø¯Ø± production):

### 1ï¸âƒ£ Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ Migration Ù…Ø´Ú©Ù„â€ŒØ¯Ø§Ø±:

**ÙØ§ÛŒÙ„ Ù…Ø´Ú©Ù„â€ŒØ¯Ø§Ø± Ø±Ø§ Ø­Ø°Ù Ú©Ù†ÛŒØ¯:**
```bash
rm core/migrations/0006_alter_order_options_order_note_order_tracking_code_and_more.py
rm core/migrations/0007_order_note_order_tracking_code_order_updated_at.py  # Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯
```

**ÙØ§ÛŒÙ„ Ø§Ù…Ù† Ø±Ø§ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ù†ÛŒØ¯:**
```bash
# Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ core/migrations/0006_safe_order_fields_update.py
```

Ù…Ø­ØªÙˆØ§ÛŒ ÙØ§ÛŒÙ„:
```python
# Safe migration for production - handles existing columns gracefully
# Generated by Django 5.1 on 2025-10-04 09:00

from django.db import migrations, models


def safe_add_order_fields(apps, schema_editor):
    """
    Safely add fields to Order model without causing duplicate column errors.
    This function checks if columns exist before adding them.
    """
    
    with schema_editor.connection.cursor() as cursor:
        
        # Check and add tracking_code field
        try:
            cursor.execute("SELECT tracking_code FROM core_order LIMIT 1")
            # Column exists, skip
        except Exception:
            # Column doesn't exist, add it
            cursor.execute("""
                ALTER TABLE core_order 
                ADD COLUMN tracking_code VARCHAR(100) NULL
            """)
        
        # Check and add note field  
        try:
            cursor.execute("SELECT note FROM core_order LIMIT 1")
            # Column exists, skip
        except Exception:
            # Column doesn't exist, add it
            cursor.execute("""
                ALTER TABLE core_order 
                ADD COLUMN note TEXT NULL
            """)
        
        # Check and add updated_at field
        try:
            cursor.execute("SELECT updated_at FROM core_order LIMIT 1")
            # Column exists, skip  
        except Exception:
            # Column doesn't exist, add it
            cursor.execute("""
                ALTER TABLE core_order 
                ADD COLUMN updated_at TIMESTAMPTZ DEFAULT NOW()
            """)


def reverse_add_order_fields(apps, schema_editor):
    """
    Reverse the migration by removing the added fields.
    """
    with schema_editor.connection.cursor() as cursor:
        try:
            cursor.execute("ALTER TABLE core_order DROP COLUMN IF EXISTS tracking_code")
            cursor.execute("ALTER TABLE core_order DROP COLUMN IF EXISTS note")  
            cursor.execute("ALTER TABLE core_order DROP COLUMN IF EXISTS updated_at")
        except Exception:
            # Ignore errors during reverse - fields might not exist
            pass


class Migration(migrations.Migration):

    dependencies = [
        ('core', '0005_sitesettings'),
    ]

    operations = [
        # Update model metadata (always safe)
        migrations.AlterModelOptions(
            name='order',
            options={
                'ordering': ['-created_at'], 
                'verbose_name': 'Ø³ÙØ§Ø±Ø´', 
                'verbose_name_plural': 'Ø³ÙØ§Ø±Ø´Ø§Øª'
            },
        ),
        
        # Safely add fields using custom SQL
        migrations.RunPython(
            safe_add_order_fields,
            reverse_add_order_fields
        ),
    ]
```

### 2ï¸âƒ£ Deploy Ù…Ø¬Ø¯Ø¯:
```bash
# Ù¾Ø³ Ø§Ø² Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ ÙØ§ÛŒÙ„ØŒ deploy Ù…Ø¬Ø¯Ø¯ Ú©Ù†ÛŒØ¯
git add .
git commit -m "Fix production migration - safe column addition"  
git push
```

### 3ï¸âƒ£ Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø§ÛŒ Ø§ØªÙ…Ø§Ù… Deploy:
- Railway Ø®ÙˆØ¯Ú©Ø§Ø± deploy Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ø´Ø±ÙˆØ¹ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
- Migration Ø¬Ø¯ÛŒØ¯ Ø¨Ø¯ÙˆÙ† Ø®Ø·Ø§ Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯
- Healthcheck Ù…ÙˆÙÙ‚ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯

## âœ… ØªØ§ÛŒÛŒØ¯ Ø±ÙØ¹ Ù…Ø´Ú©Ù„:

Ù¾Ø³ Ø§Ø² deploy Ù…ÙˆÙÙ‚ØŒ Ø³Ø±ÙˆØ± Ø¨Ø§ÛŒØ¯:
1. âœ… Ø¨Ø¯ÙˆÙ† Ø®Ø·Ø§ÛŒ migration start Ø´ÙˆØ¯
2. âœ… Healthcheck Ù…ÙˆÙÙ‚ Ø¨Ø§Ø´Ø¯  
3. âœ… ØªÙ…Ø§Ù… ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Order model Ú©Ø§Ø± Ú©Ù†Ø¯

## ğŸ“ Ø¯Ø± ØµÙˆØ±Øª Ø§Ø¯Ø§Ù…Ù‡ Ù…Ø´Ú©Ù„:

Ø§Ú¯Ø± Ù‡Ù†ÙˆØ² Ù…Ø´Ú©Ù„ Ø¯Ø§Ø±ÛŒØ¯ØŒ Ø§ÛŒÙ† Ø¯Ø³ØªÙˆØ±Ø§Øª Ø±Ø§ Ø¯Ø± production Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯:

```bash
# Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø² - fake migration
python manage.py migrate core 0006 --fake

# ÛŒØ§ reset Ú©Ø§Ù…Ù„ migration
python manage.py showmigrations core
python manage.py migrate core 0005  # Ø¨Ø±Ú¯Ø´Øª Ø¨Ù‡ migration Ù‚Ø¨Ù„ÛŒ
python manage.py migrate core 0006  # Ø§Ø¬Ø±Ø§ÛŒ migration Ø¬Ø¯ÛŒØ¯
```

## ğŸ¯ Ø®Ù„Ø§ØµÙ‡:
**Migration Ø¬Ø¯ÛŒØ¯ Ú©Ø§Ù…Ù„Ø§Ù‹ Ø§Ù…Ù† Ø§Ø³Øª Ùˆ Ø®Ø·Ø§ÛŒ "column already exists" Ø±Ø§ Ø­Ù„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.**

**â±ï¸ Ø²Ù…Ø§Ù† ØªØ®Ù…ÛŒÙ†ÛŒ Ø­Ù„ Ù…Ø´Ú©Ù„: 2-3 Ø¯Ù‚ÛŒÙ‚Ù‡ Ù¾Ø³ Ø§Ø² deploy**