# 🚨 راه حل فوری برای رفع خرابی Production Server

## ⚠️ وضعیت فعلی:
- Production server در حال healthcheck failure است
- Migration های Django باعث خرابی شده‌اند
- `column "tracking_code" of relation "core_order" already exists` error

## ⚡ راه حل فوری (اقدام فوری در production):

### 1️⃣ جایگزینی Migration مشکل‌دار:

**فایل مشکل‌دار را حذف کنید:**
```bash
rm core/migrations/0006_alter_order_options_order_note_order_tracking_code_and_more.py
rm core/migrations/0007_order_note_order_tracking_code_order_updated_at.py  # اگر وجود دارد
```

**فایل امن را ایجاد کنید:**
```bash
# ایجاد فایل core/migrations/0006_safe_order_fields_update.py
```

محتوای فایل:
```python
# Safe migration for production - handles existing columns gracefully
# Generated by Django 5.1 on 2025-10-04 09:00

from django.db import migrations, models


def safe_add_order_fields(apps, schema_editor):
    """
    Safely add fields to Order model without causing duplicate column errors.
    This function checks if columns exist before adding them.
    """
    
    with schema_editor.connection.cursor() as cursor:
        
        # Check and add tracking_code field
        try:
            cursor.execute("SELECT tracking_code FROM core_order LIMIT 1")
            # Column exists, skip
        except Exception:
            # Column doesn't exist, add it
            cursor.execute("""
                ALTER TABLE core_order 
                ADD COLUMN tracking_code VARCHAR(100) NULL
            """)
        
        # Check and add note field  
        try:
            cursor.execute("SELECT note FROM core_order LIMIT 1")
            # Column exists, skip
        except Exception:
            # Column doesn't exist, add it
            cursor.execute("""
                ALTER TABLE core_order 
                ADD COLUMN note TEXT NULL
            """)
        
        # Check and add updated_at field
        try:
            cursor.execute("SELECT updated_at FROM core_order LIMIT 1")
            # Column exists, skip  
        except Exception:
            # Column doesn't exist, add it
            cursor.execute("""
                ALTER TABLE core_order 
                ADD COLUMN updated_at TIMESTAMPTZ DEFAULT NOW()
            """)


def reverse_add_order_fields(apps, schema_editor):
    """
    Reverse the migration by removing the added fields.
    """
    with schema_editor.connection.cursor() as cursor:
        try:
            cursor.execute("ALTER TABLE core_order DROP COLUMN IF EXISTS tracking_code")
            cursor.execute("ALTER TABLE core_order DROP COLUMN IF EXISTS note")  
            cursor.execute("ALTER TABLE core_order DROP COLUMN IF EXISTS updated_at")
        except Exception:
            # Ignore errors during reverse - fields might not exist
            pass


class Migration(migrations.Migration):

    dependencies = [
        ('core', '0005_sitesettings'),
    ]

    operations = [
        # Update model metadata (always safe)
        migrations.AlterModelOptions(
            name='order',
            options={
                'ordering': ['-created_at'], 
                'verbose_name': 'سفارش', 
                'verbose_name_plural': 'سفارشات'
            },
        ),
        
        # Safely add fields using custom SQL
        migrations.RunPython(
            safe_add_order_fields,
            reverse_add_order_fields
        ),
    ]
```

### 2️⃣ Deploy مجدد:
```bash
# پس از جایگزینی فایل، deploy مجدد کنید
git add .
git commit -m "Fix production migration - safe column addition"  
git push
```

### 3️⃣ انتظار برای اتمام Deploy:
- Railway خودکار deploy جدید را شروع می‌کند
- Migration جدید بدون خطا اجرا می‌شود
- Healthcheck موفق خواهد شد

## ✅ تایید رفع مشکل:

پس از deploy موفق، سرور باید:
1. ✅ بدون خطای migration start شود
2. ✅ Healthcheck موفق باشد  
3. ✅ تمام فیلدهای Order model کار کند

## 📞 در صورت ادامه مشکل:

اگر هنوز مشکل دارید، این دستورات را در production اجرا کنید:

```bash
# در صورت نیاز - fake migration
python manage.py migrate core 0006 --fake

# یا reset کامل migration
python manage.py showmigrations core
python manage.py migrate core 0005  # برگشت به migration قبلی
python manage.py migrate core 0006  # اجرای migration جدید
```

## 🎯 خلاصه:
**Migration جدید کاملاً امن است و خطای "column already exists" را حل می‌کند.**

**⏱️ زمان تخمینی حل مشکل: 2-3 دقیقه پس از deploy**